
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sejarawan-AI Chatbot</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --theme-gradient: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
      --user-msg-bg: #e6f0ff;
      --bg-color: #fdf6e3; /* Parchment color */
      --text-color: #3d2c1c; /* Dark brown for text */
      --border-color: #d2b48c; /* Tan/Sepia border */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Lora', serif;
      background: var(--bg-color);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .main-container {
      display: flex;
      width: 100%;
      max-width: 1100px;
      height: 90vh;
      max-height: 750px;
      background: #faf8f2;
      border-radius: 15px;
      box-shadow: 0 15px 50px rgba(0,0,0,0.2);
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .chat-history-container {
      width: 300px;
      background: #fdfbf7;
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
    }

    .new-chat-btn-container {
      padding: 25px;
      border-bottom: 1px solid var(--border-color);
      text-align: center;
    }

    #new-chat-btn {
      width: 100%;
      padding: 12px;
      background: var(--theme-gradient);
      color: white;
      border: none;
      border-radius: 8px;
      font-family: 'Lora', serif;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #new-chat-btn:hover {
      opacity: 0.9;
      box-shadow: 0 4px 15px rgba(75, 108, 183, 0.3);
    }

    #chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .chat-history-item {
      padding: 12px 15px;
      cursor: pointer;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 15px;
      color: var(--text-color);
      border-left: 3px solid transparent;
      transition: all 0.2s ease;
    }

    .chat-history-item:hover {
      background: #f5efe1;
      border-left: 3px solid #4b6cb7;
    }

    .chat-history-item.active {
      background: #e6f0ff;
      color: #182848;
      font-weight: 600;
      border-left: 3px solid #182848;
    }
    
    .container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .header {
      background: var(--theme-gradient);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-bottom: 1px solid #182848;
      position: relative;
    }
    
    .header h1 {
      font-size: 26px;
      font-weight: 600;
      margin-bottom: 5px;
      cursor: default;
      user-select: none;
    }
    
    .header p {
      font-size: 15px;
      opacity: 0.9;
    }

    /* Hidden Admin Button */
    #admin-access-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 8px;
      height: 8px;
      background: transparent;
      border: none;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s;
      padding: 0;
      z-index: 1000;
    }

    #admin-access-btn:hover {
      opacity: 0.3;
      width: 30px;
      height: 30px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
    }

    /* Admin notification badge */
    .admin-badge {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 15px;
      background: rgba(75, 108, 183, 0.95);
      color: white;
      border-radius: 8px;
      font-size: 13px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease-out;
      z-index: 10000;
      cursor: pointer;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    #chat {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      background: var(--bg-color);
    }
    
    #chat::-webkit-scrollbar { width: 8px; }
    #chat::-webkit-scrollbar-track { background: #f5efe1; }
    #chat::-webkit-scrollbar-thumb { background: #4b6cb7; border-radius: 4px; }
    
    .msg {
      margin-bottom: 20px;
      display: flex;
      align-items: flex-end;
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .msg.user { flex-direction: row-reverse; }
    
    .msg-content {
      max-width: 75%;
      padding: 15px 20px;
      border-radius: 18px;
      word-wrap: break-word;
      line-height: 1.6;
      color: var(--text-color);
    }
    
    .msg.user .msg-content {
      background: var(--user-msg-bg);
      color: #182848;
      border-bottom-right-radius: 5px;
      margin-left: 12px;
    }
    
    .msg.bot .msg-content {
      background: #fffdfa;
      border: 1px solid var(--border-color);
      border-bottom-left-radius: 5px;
      margin-right: 12px;
    }
    
    .avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid var(--border-color);
    }
    
    #controls {
      padding: 20px;
      background: #faf8f2;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    input[type=text] {
      flex: 1;
      padding: 14px 20px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      font-size: 16px;
      font-family: 'Lora', serif;
      outline: none;
      background: #fffdfa;
      transition: all 0.3s ease;
    }
    
    input[type=text]:focus {
      border-color: #4b6cb7;
      box-shadow: 0 0 0 4px rgba(75, 108, 183, 0.1);
    }
    
    #send, #mic-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 1px solid var(--border-color);
      color: #182848;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      transition: all 0.3s ease;
    }

    #send {
        background: var(--theme-gradient);
        color: white;
        border: none;
    }

    #mic-btn:hover, #send:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }
    
    #mic-btn.listening {
      background: #c0392b;
      color: white;
      border-color: #c0392b;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); }
      70% { box-shadow: 0 0 0 12px rgba(192, 57, 43, 0); }
      100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); }
    }
    
    .typing { display: inline-flex; gap: 5px; padding: 15px; }
    .typing span { width: 9px; height: 9px; border-radius: 50%; background: #4b6cb7; animation: typing 1.4s infinite; }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="chat-history-container">
      <div class="new-chat-btn-container">
        <button id="new-chat-btn">üìú Sesi Baru</button>
      </div>
      <div id="chat-history"></div>
    </div>
    <div class="container">
      <div class="header">
        <button id="admin-access-btn" title="Admin Access" aria-label="Admin Panel Access"></button>
        <h1 id="header-title">Sejarawan AI üèõÔ∏è</h1>
        <p>Jelajahi lembaran masa lalu dunia bersama saya.</p>
      </div>
      <div id="chat"></div>
      <div id="controls">
        <button id="mic-btn" title="Aktifkan Mikrofon">üé§</button> 
        <input id="input" type="text" placeholder="Ajukan pertanyaan sejarah Anda..." />
        <button id="send" title="Kirim Pertanyaan">‚û§</button>
      </div>
    </div>
  </div>

<script src="db.js"></script>
<script>
  const chatEl = document.getElementById('chat');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('send');
  const micBtn = document.getElementById('mic-btn');
  const newChatBtn = document.getElementById('new-chat-btn');
  const chatHistoryEl = document.getElementById('chat-history');
  const adminBtn = document.getElementById('admin-access-btn');
  const headerTitle = document.getElementById('header-title');

  let currentSessionId = null;
  let adminClickCount = 0;
  let adminClickTimer = null;

  // === HIDDEN ADMIN ACCESS ===
  // Triple-click on header title untuk akses admin
  headerTitle.addEventListener('click', function() {
    adminClickCount++;
    
    if (adminClickTimer) clearTimeout(adminClickTimer);
    
    if (adminClickCount === 3) {
      showAdminAccess();
      adminClickCount = 0;
    } else {
      adminClickTimer = setTimeout(() => {
        adminClickCount = 0;
      }, 1000);
    }
  });

  // Hidden button untuk admin access
  adminBtn.addEventListener('click', function() {
    showAdminAccess();
  });

  function showAdminAccess() {
    const badge = document.createElement('div');
    badge.className = 'admin-badge';
    badge.innerHTML = 'üîê Akses Admin Panel <span style="font-size:10px">(klik untuk masuk)</span>';
    document.body.appendChild(badge);
    
    badge.addEventListener('click', function() {
      // Redirect to admin panel - akan minta authentication
      window.location.href = '/admin-dashboard-7f3e9b2a1c8d4f6e';
    });

    setTimeout(() => {
      badge.style.opacity = '0';
      setTimeout(() => badge.remove(), 300);
    }, 5000);
  }

  // === SECURITY: HTML Sanitization untuk mencegah XSS ===
  function sanitizeHTML(text) {
    const div = document.createElement('div');
    div.textContent = text; // textContent otomatis escape HTML
    return div.innerHTML;
  }

  // === SECURITY: Input validation ===
  function isValidInput(text) {
    // Cek panjang
    if (text.length > 2000) {
      return { valid: false, error: 'Pesan terlalu panjang (maksimal 2000 karakter)' };
    }
    
    // Cek karakter mencurigakan berlebihan
    if (/(.)\1{50,}/.test(text)) {
      return { valid: false, error: 'Pola pesan tidak valid' };
    }
    
    return { valid: true, error: null };
  }

  async function initialize() {
    await openDB();
    await loadChatSessions();
    if (!currentSessionId && chatHistoryEl.children.length > 0) {
        const firstSessionId = chatHistoryEl.children[0].dataset.sessionId;
        await loadChat(firstSessionId);
    } else if (!currentSessionId) {
        await startNewChat();
    }
  }

  function append(role, text, isTyping = false){
    const msgDiv = document.createElement('div');
    msgDiv.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
    
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = role === 'user' ? '‚úíÔ∏è' : 'üìú';
    
    const content = document.createElement('div');
    content.className = 'msg-content';
    
    if (isTyping) {
      content.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
    } else {
      // SECURITY: Gunakan textContent untuk mencegah XSS
      content.textContent = text;
    }
    
    msgDiv.appendChild(avatar);
    msgDiv.appendChild(content);
    chatEl.appendChild(msgDiv);
    chatEl.scrollTop = chatEl.scrollHeight;
    
    return msgDiv;
  }

  function speak(text) {
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'id-ID';
    utterance.rate = 1.0;
    utterance.pitch = 1.0;

    const setVoiceAndSpeak = () => {
        const voices = window.speechSynthesis.getVoices();
        const femaleVoice = voices.find(voice => 
            voice.lang === 'id-ID' && 
            (voice.name.includes('Female') || voice.name.includes('Wanita') || voice.name === 'Google Bahasa Indonesia')
        );
        
        if (femaleVoice) {
            utterance.voice = femaleVoice;
        } else {
            const anyIndonesianVoice = voices.find(voice => voice.lang === 'id-ID');
            if (anyIndonesianVoice) {
                utterance.voice = anyIndonesianVoice;
            }
        }
        window.speechSynthesis.speak(utterance);
    };

    if (window.speechSynthesis.getVoices().length > 0) {
        setVoiceAndSpeak();
    } else {
        window.speechSynthesis.onvoiceschanged = setVoiceAndSpeak;
    }
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  if (SpeechRecognition) {
    const recognition = new SpeechRecognition();
    recognition.lang = 'id-ID';
    recognition.continuous = false;

    micBtn.onclick = () => {
      if (micBtn.classList.contains('listening')) {
        recognition.stop();
      } else {
        recognition.start();
      }
    };

    recognition.onstart = () => {
      micBtn.classList.add('listening');
      inputEl.placeholder = "Mendengarkan...";
    };

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      inputEl.value = transcript;
    };

    recognition.onend = () => {
      micBtn.classList.remove('listening');
      inputEl.placeholder = "Ajukan pertanyaan sejarah Anda...";
      inputEl.focus();
    };

    recognition.onerror = (event) => {
      console.error("Mic Error:", event.error);
      micBtn.classList.remove('listening');
      inputEl.placeholder = "Error mikrofon / Izin ditolak";
    };
  } else {
    micBtn.style.display = 'none';
    console.log("Web Speech API tidak didukung di browser ini.");
  }

  async function send(){
    const text = inputEl.value.trim();
    if(!text || !currentSessionId) return;
    
    // SECURITY: Validasi input di client-side
    const validation = isValidInput(text);
    if (!validation.valid) {
      append('bot', `‚ö†Ô∏è ${validation.error}`);
      return;
    }
    
    inputEl.disabled = true;
    sendBtn.disabled = true;
    
    append('user', text);
    await saveMessage(currentSessionId, 'user', text);
    inputEl.value = '';
    
    const typingMsg = append('bot', '', true);

    try{
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ message: text })
      });
      const data = await res.json();
      
      typingMsg.remove();
      
      if(res.ok) {
        const replyText = data.reply || 'Maaf, saya tidak dapat memberikan balasan saat ini.';
        append('bot', replyText);
        await saveMessage(currentSessionId, 'bot', replyText);
        speak(replyText);
      } else {
        // SECURITY: Jangan tampilkan detail error dari server
        const errorMsg = data.reply || data.error || 'Gagal memproses permintaan';
        append('bot', errorMsg);
      }
    }catch(e){
      typingMsg.remove();
      append('bot', '‚ùå Error: Koneksi gagal. Pastikan server sedang berjalan.');
      console.error('Connection error:', e);
    }
    
    inputEl.disabled = false;
    sendBtn.disabled = false;
    inputEl.focus();
  }

  sendBtn.onclick = send;
  inputEl.addEventListener('keydown', (e)=>{ 
    if(e.key === 'Enter' && !inputEl.disabled) send(); 
  });
  
  async function startNewChat() {
    chatEl.innerHTML = '';
    const welcomeMsg = 'Selamat datang di arsip sejarah digital saya. Silakan ajukan pertanyaan mengenai peristiwa, tokoh, atau era mana pun dalam sejarah dunia.';
    append('bot', welcomeMsg);
    currentSessionId = await createChatSession();
    await loadChatSessions();
    setActiveChat(currentSessionId);
  }

  newChatBtn.onclick = startNewChat;

  async function loadChatSessions() {
    const sessions = await loadAllChatSessions();
    chatHistoryEl.innerHTML = '';
    sessions.reverse().forEach(session => {
        const sessionDiv = document.createElement('div');
        sessionDiv.className = 'chat-history-item';
        sessionDiv.textContent = `Sesi ${new Date(session.created_at).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}`;
        sessionDiv.dataset.sessionId = session.id;
        sessionDiv.onclick = () => loadChat(session.id);
        chatHistoryEl.appendChild(sessionDiv);
    });
  }

  async function loadChat(sessionId) {
    currentSessionId = sessionId;
    chatEl.innerHTML = '';
    const messages = await loadMessages(sessionId);
    if(messages.length === 0) {
        const welcomeMsg = 'Selamat datang kembali. Sesi ini kosong. Apa yang ingin Anda diskusikan dari masa lalu?';
        append('bot', welcomeMsg);
    } else {
        messages.forEach(msg => append(msg.role, msg.text));
    }
    setActiveChat(sessionId);
  }
  
  function setActiveChat(sessionId) {
    document.querySelectorAll('.chat-history-item').forEach(item => {
      if (item.dataset.sessionId == sessionId) {
        item.classList.add('active');
      } else {
        item.classList.remove('active');
      }
    });
  }

  initialize();
</script>
</body>
</html>
